<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRD Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
            font-weight: 600;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">PRD Generator</h1>
                    <p class="text-gray-600 text-sm mt-1">Transform documents into actionable product plans</p>
                </div>
                <div class="flex items-center gap-4">
                    <a href="viewer.html" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium">
                        üìã View Jobs
                    </a>
                    <div class="text-sm text-gray-500">
                        API: <span id="apiStatus" class="text-gray-400">Checking...</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 max-w-6xl">

        <!-- Tabs -->
        <div class="mb-8 border-b border-gray-200">
            <nav class="flex space-x-8">
                <button
                    onclick="showTab('upload')"
                    id="uploadTab"
                    class="py-4 px-1 tab-active">
                    üì§ Upload Documents
                </button>
                <button
                    onclick="showTab('path')"
                    id="pathTab"
                    class="py-4 px-1 text-gray-600 hover:text-gray-900">
                    üìÅ Use Folder Path
                </button>
            </nav>
        </div>

        <!-- Upload Tab Content -->
        <div id="uploadContent" class="bg-white rounded-lg shadow-lg p-8">
            <div class="max-w-3xl mx-auto">
                <h2 class="text-2xl font-semibold mb-6">Upload Documents</h2>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Select documents (.txt, .md, .docx)
                    </label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-gray-400 transition">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="flex text-sm text-gray-600">
                                <label for="fileInput" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500">
                                    <span>Upload files</span>
                                    <input
                                        id="fileInput"
                                        type="file"
                                        multiple
                                        accept=".txt,.md,.docx"
                                        class="sr-only"
                                        onchange="updateFileList()">
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500">TXT, MD, DOCX files</p>
                        </div>
                    </div>
                </div>

                <!-- Selected Files -->
                <div id="fileList" class="mb-6 hidden">
                    <p class="text-sm font-medium text-gray-700 mb-2">Selected files:</p>
                    <ul id="fileListItems" class="bg-gray-50 rounded p-4 space-y-1"></ul>
                </div>

                <!-- Artifact Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">
                        Select Artifacts to Generate
                    </label>

                    <!-- Quick Selection Buttons -->
                    <div class="mb-4 flex gap-2 flex-wrap">
                        <button type="button" onclick="selectArtifactSet('business')" id="set-business"
                                class="px-4 py-2 bg-blue-50 text-blue-700 rounded-md hover:bg-blue-100 border-2 border-blue-300 text-sm font-medium">
                            üìä Business (Recommended)
                        </button>
                        <button type="button" onclick="selectArtifactSet('minimal')" id="set-minimal"
                                class="px-4 py-2 bg-gray-50 text-gray-700 rounded-md hover:bg-gray-100 border border-gray-200 text-sm">
                            üìù Minimal (PRD Only)
                        </button>
                        <button type="button" onclick="selectArtifactSet('development')" id="set-development"
                                class="px-4 py-2 bg-gray-50 text-gray-700 rounded-md hover:bg-gray-100 border border-gray-200 text-sm">
                            üíª Development
                        </button>
                        <button type="button" onclick="selectArtifactSet('complete')" id="set-complete"
                                class="px-4 py-2 bg-gray-50 text-gray-700 rounded-md hover:bg-gray-100 border border-gray-200 text-sm">
                            ‚ú® Complete (All)
                        </button>
                    </div>

                    <!-- Individual Checkboxes -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="prd" checked class="artifact-checkbox rounded text-blue-600">
                                <span class="text-sm">üìù PRD</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="capabilities" checked class="artifact-checkbox rounded text-blue-600">
                                <span class="text-sm">üó∫Ô∏è Capabilities</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="capability_cards" class="artifact-checkbox rounded text-blue-600">
                                <span class="text-sm">üé¥ Capability Cards</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="epics" class="artifact-checkbox rounded text-blue-600">
                                <span class="text-sm">üéØ Epics</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="features" class="artifact-checkbox rounded text-blue-600">
                                <span class="text-sm">‚ú® Features</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="user_stories" class="artifact-checkbox rounded text-blue-600">
                                <span class="text-sm">üë§ User Stories</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" value="lean_canvas" checked class="artifact-checkbox rounded text-blue-600">
                                <span class="text-sm">üìä Lean Canvas</span>
                            </label>
                        </div>
                    </div>

                    <p class="text-xs text-gray-500 mt-2">
                        ‚ÑπÔ∏è Dependencies are automatically included. Selecting "Features" will also generate PRD and Epics.
                    </p>
                </div>

                <!-- Output Format Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Output Formats
                    </label>
                    <div class="flex gap-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="format_markdown" checked class="rounded text-blue-600">
                            <span class="text-sm">üìÑ Markdown</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="format_json" checked class="rounded text-blue-600">
                            <span class="text-sm">üìä JSON</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="format_html" checked class="rounded text-blue-600">
                            <span class="text-sm">üåê HTML Report</span>
                        </label>
                    </div>
                </div>

                <!-- Generate Button -->
                <button
                    onclick="uploadAndGenerate()"
                    id="uploadButton"
                    class="w-full px-6 py-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Generate PRD Artifacts
                </button>

                <!-- Status -->
                <div id="uploadStatus" class="mt-6"></div>
            </div>
        </div>

        <!-- Path Tab Content -->
        <div id="pathContent" class="bg-white rounded-lg shadow-lg p-8 hidden">
            <div class="max-w-3xl mx-auto">
                <h2 class="text-2xl font-semibold mb-6">Generate from Folder Path</h2>

                <div class="mb-6">
                    <label for="folderPath" class="block text-sm font-medium text-gray-700 mb-2">
                        Enter folder path containing documents
                    </label>
                    <input
                        type="text"
                        id="folderPath"
                        placeholder="/Users/your-name/Documents/project-docs"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <p class="mt-2 text-sm text-gray-500">
                        Example: examples/loan_underwriting_docs
                    </p>
                </div>

                <button
                    onclick="generateFromPath()"
                    id="pathButton"
                    class="w-full px-6 py-4 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Generate PRD Artifacts
                </button>

                <!-- Status -->
                <div id="pathStatus" class="mt-6"></div>
            </div>
        </div>

        <!-- Info Section -->
        <div class="mt-12 bg-blue-50 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-blue-900 mb-3">What gets generated?</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div class="bg-white rounded p-3">
                    <div class="font-medium text-blue-900">üìÑ PRD</div>
                    <div class="text-gray-600 text-xs">Product Requirements</div>
                </div>
                <div class="bg-white rounded p-3">
                    <div class="font-medium text-blue-900">üéØ Epics</div>
                    <div class="text-gray-600 text-xs">High-level initiatives</div>
                </div>
                <div class="bg-white rounded p-3">
                    <div class="font-medium text-blue-900">‚ú® Features</div>
                    <div class="text-gray-600 text-xs">With acceptance criteria</div>
                </div>
                <div class="bg-white rounded p-3">
                    <div class="font-medium text-blue-900">üìù User Stories</div>
                    <div class="text-gray-600 text-xs">Developer-ready</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'http://localhost:8000';

        // Artifact set definitions
        const ARTIFACT_SETS = {
            'business': ['prd', 'capabilities', 'lean_canvas'],
            'minimal': ['prd'],
            'development': ['prd', 'capabilities', 'capability_cards', 'epics', 'features'],
            'complete': ['prd', 'capabilities', 'capability_cards', 'epics', 'features', 'user_stories', 'lean_canvas']
        };

        function selectArtifactSet(setName) {
            const artifacts = ARTIFACT_SETS[setName] || [];

            // Uncheck all first
            document.querySelectorAll('.artifact-checkbox').forEach(cb => {
                cb.checked = false;
            });

            // Check selected set
            artifacts.forEach(artifact => {
                const checkbox = document.querySelector(`.artifact-checkbox[value="${artifact}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });

            // Update button styles
            document.querySelectorAll('[id^="set-"]').forEach(btn => {
                btn.className = 'px-4 py-2 bg-gray-50 text-gray-700 rounded-md hover:bg-gray-100 border border-gray-200 text-sm';
            });
            document.getElementById(`set-${setName}`).className = 'px-4 py-2 bg-blue-50 text-blue-700 rounded-md hover:bg-blue-100 border-2 border-blue-300 text-sm font-medium';
        }

        // Initialize with business set (default)
        window.addEventListener('DOMContentLoaded', () => {
            selectArtifactSet('business');
        });

        // Check API status on load
        async function checkAPIStatus() {
            try {
                const response = await fetch(`${API_URL}/`);
                const data = await response.json();
                document.getElementById('apiStatus').innerHTML =
                    '<span class="text-green-600">‚óè Connected</span>';
            } catch (error) {
                document.getElementById('apiStatus').innerHTML =
                    '<span class="text-red-600">‚óè Disconnected</span>';
            }
        }
        checkAPIStatus();

        function showTab(tab) {
            // Update tab styling
            document.getElementById('uploadTab').classList.toggle('tab-active', tab === 'upload');
            document.getElementById('uploadTab').classList.toggle('text-gray-600', tab !== 'upload');
            document.getElementById('pathTab').classList.toggle('tab-active', tab === 'path');
            document.getElementById('pathTab').classList.toggle('text-gray-600', tab !== 'path');

            // Show/hide content
            document.getElementById('uploadContent').classList.toggle('hidden', tab !== 'upload');
            document.getElementById('pathContent').classList.toggle('hidden', tab !== 'path');
        }

        function updateFileList() {
            const files = document.getElementById('fileInput').files;
            const fileList = document.getElementById('fileList');
            const fileListItems = document.getElementById('fileListItems');

            if (files.length > 0) {
                fileList.classList.remove('hidden');
                fileListItems.innerHTML = '';
                Array.from(files).forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'text-sm text-gray-700';
                    li.textContent = `üìÑ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                    fileListItems.appendChild(li);
                });
            } else {
                fileList.classList.add('hidden');
            }
        }

        async function pollProgress(jobId, statusElement, onComplete) {
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_URL}/api/jobs/${jobId}/progress`);
                    if (!response.ok) {
                        clearInterval(pollInterval);
                        return;
                    }

                    const progress = await response.json();

                    // Update status with progress
                    statusElement.innerHTML = `
                        <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded">
                            <div class="flex items-center mb-2">
                                <div class="spinner mr-3"></div>
                                <div class="font-semibold">${progress.step}</div>
                            </div>
                            <div class="text-sm mb-2">${progress.message}</div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${progress.progress}%"></div>
                            </div>
                            <div class="text-xs mt-1 text-blue-600">${progress.progress}% complete</div>
                        </div>
                    `;

                    // Check if completed
                    if (progress.status === 'completed') {
                        clearInterval(pollInterval);
                        onComplete(progress);
                    }
                } catch (error) {
                    console.error('Error polling progress:', error);
                }
            }, 10000); // Poll every 10 seconds
        }

        async function uploadAndGenerate() {
            const files = document.getElementById('fileInput').files;
            const status = document.getElementById('uploadStatus');
            const button = document.getElementById('uploadButton');

            if (files.length === 0) {
                status.innerHTML = `
                    <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded">
                        Please select at least one document file.
                    </div>
                `;
                return;
            }

            // Get selected artifacts
            const selectedArtifacts = Array.from(document.querySelectorAll('.artifact-checkbox:checked'))
                .map(cb => cb.value);

            if (selectedArtifacts.length === 0) {
                status.innerHTML = `
                    <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded">
                        Please select at least one artifact to generate.
                    </div>
                `;
                return;
            }

            // Get output formats
            const formats = [];
            if (document.getElementById('format_markdown').checked) formats.push('markdown');
            if (document.getElementById('format_json').checked) formats.push('json');
            if (document.getElementById('format_html').checked) formats.push('html');

            button.disabled = true;
            status.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded flex items-center">
                    <div class="spinner mr-3"></div>
                    <div>
                        <div class="font-semibold">Uploading files...</div>
                        <div class="text-sm">Preparing to generate ${selectedArtifacts.length} artifact(s)...</div>
                    </div>
                </div>
            `;

            const formData = new FormData();
            Array.from(files).forEach(file => {
                formData.append('files', file);
            });

            try {
                // Start the generation job using selective endpoint
                const url = `${API_URL}/api/generate-selective?artifacts=${selectedArtifacts.join(',')}&output_formats=${formats.join(',')}&use_cache=true`;
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Generation failed');
                }

                const result = await response.json();

                // Start polling for progress
                pollProgress(result.job_id, status, (progress) => {
                    // On completion
                    status.innerHTML = `
                        <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded">
                            <div class="font-semibold mb-3">‚úÖ Generation complete!</div>

                            <div class="bg-white border border-green-300 rounded-lg p-4 mb-4">
                                <div class="text-sm font-medium text-gray-700 mb-2">Your Job ID:</div>
                                <div class="flex items-center gap-2">
                                    <code class="flex-1 text-sm text-gray-900 bg-gray-100 px-3 py-2 rounded break-all">${result.job_id}</code>
                                    <button onclick="navigator.clipboard.writeText('${result.job_id}').then(() => alert('Job ID copied!'))"
                                            class="px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition text-sm">
                                        üìã Copy
                                    </button>
                                </div>
                            </div>

                            <div class="flex gap-3">
                                <a href="viewer.html?job=${result.job_id}"
                                   class="flex-1 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition text-center">
                                    üëÅÔ∏è View Artifacts
                                </a>
                                <a href="${API_URL}/api/download/${result.job_id}"
                                   class="flex-1 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition text-center">
                                    üì• Download ZIP
                                </a>
                            </div>
                        </div>
                    `;
                    button.disabled = false;
                });

            } catch (error) {
                status.innerHTML = `
                    <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded">
                        <div class="font-semibold">Error:</div>
                        <div class="text-sm">${error.message}</div>
                    </div>
                `;
                button.disabled = false;
            }
        }

        async function generateFromPath() {
            const path = document.getElementById('folderPath').value.trim();
            const status = document.getElementById('pathStatus');
            const button = document.getElementById('pathButton');

            if (!path) {
                status.innerHTML = `
                    <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded">
                        Please enter a folder path.
                    </div>
                `;
                return;
            }

            button.disabled = true;
            status.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded flex items-center">
                    <div class="spinner mr-3"></div>
                    <div>
                        <div class="font-semibold">Generating artifacts...</div>
                        <div class="text-sm">This may take 1-2 minutes depending on document size</div>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`${API_URL}/api/generate-from-path`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ folder_path: path })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Generation failed');
                }

                const result = await response.json();

                status.innerHTML = `
                    <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded">
                        <div class="font-semibold mb-3">‚úÖ Generation complete!</div>

                        <div class="bg-white border border-green-300 rounded-lg p-4 mb-4">
                            <div class="text-sm font-medium text-gray-700 mb-2">Your Job ID:</div>
                            <div class="flex items-center gap-2 mb-3">
                                <code class="flex-1 text-sm text-gray-900 bg-gray-100 px-3 py-2 rounded break-all">${result.job_id}</code>
                                <button onclick="navigator.clipboard.writeText('${result.job_id}').then(() => alert('Job ID copied!'))"
                                        class="px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition text-sm">
                                    üìã Copy
                                </button>
                            </div>
                            <div class="text-sm font-medium text-gray-700 mb-1">Output Location:</div>
                            <code class="text-xs text-gray-600 break-all">${result.output_path}</code>
                        </div>

                        <div class="flex gap-3">
                            <a href="viewer.html?job=${result.job_id}"
                               class="flex-1 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition text-center">
                                üëÅÔ∏è View Artifacts
                            </a>
                        </div>
                    </div>
                `;
            } catch (error) {
                status.innerHTML = `
                    <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded">
                        <div class="font-semibold">Error:</div>
                        <div class="text-sm">${error.message}</div>
                    </div>
                `;
            } finally {
                button.disabled = false;
            }
        }
    </script>
</body>
</html>
